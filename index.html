<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
      body { background-color: #eef2f7; font-family: 'Sarabun', sans-serif; }
      
      /* Login Styles */
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .login-card {
        width: 100%;
        max-width: 400px;
        padding: 40px;
        border-radius: 15px;
        background: white;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }
      .brand-logo {
        width: 80px;
        height: 80px;
        background: #0d6efd; /* สีธีม */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 32px;
      }

      /* Main App Styles (ซ่อนไว้ก่อน) */
      #app-view { display: none; }
      .navbar-custom { background: #2c3e50; color: white; }
    </style>
  </head>
  <body>

    <div id="login-view" class="login-container">
      <div class="login-card">
        <div class="brand-logo"><i class="fas fa-user-lock"></i></div>
        <h4 class="text-center mb-4">HR System Login</h4>
        
        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="mb-3">
            <label class="form-label">Email Address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-envelope"></i></span>
              <input type="email" class="form-control" id="email" required 
                     placeholder="user@company.com"
                     value="suchanaree.kongp@gmail.com">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-key"></i></span>
              <input type="password" class="form-control" id="password" required 
                     placeholder="Enter password"
                     value="67542">
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" id="btnLogin" class="btn btn-primary btn-lg">เข้าสู่ระบบ</button>
          </div>
          
          <div id="loginAlert" class="alert alert-danger mt-3 d-none text-center fs-6"></div>
        </form>
      </div>
    </div>

    <div id="app-view">
      <nav class="navbar navbar-expand-lg navbar-custom px-3">
        <div class="container-fluid">
          <a class="navbar-brand text-white" href="#"><i class="fas fa-building"></i> HR System</a>
          <div class="d-flex align-items-center">
            <span class="me-3 text-light">
              <i class="fas fa-user-circle"></i> <span id="userNameDisplay">User Name</span> 
              <span class="badge bg-warning text-dark ms-1" id="userRoleDisplay">Role</span>
            </span>
            <button class="btn btn-outline-light btn-sm" onclick="handleLogout()">Logout</button>
          </div>
        </div>
      </nav>

      <div class="container mt-4">
        <div class="alert alert-success">
          <h4>ยินดีต้อนรับ!</h4>
          <p>คุณได้เข้าสู่ระบบเรียบร้อยแล้ว ในฐานะ <strong id="welcomeRole">...</strong></p>
        </div>
        
        <div class="row">
           <div class="col-md-4">
             <div class="card p-3 mb-3">
               <h5><i class="fas fa-clock"></i> บันทึกเวลาเข้า-ออก</h5>
               <button class="btn btn-primary mt-2">Check In</button>
             </div>
           </div>
           </div>
      </div>
    </div>

    <script>
      let currentUser = null;

      function handleLogin(e) {
        e.preventDefault();
        
        // Disable ปุ่มชั่วคราว
        const btn = document.getElementById('btnLogin');
        const alertBox = document.getElementById('loginAlert');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบ...';
        alertBox.classList.add('d-none');

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        // *** แก้ไขจุดที่ 3: ลบ input ที่เกินมาตรงนี้ออกไปแล้ว ***

        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              // Login ผ่าน
              currentUser = response.user;
              showAppView();
            } else {
              // Login ไม่ผ่าน
              alertBox.innerText = response.message;
              alertBox.classList.remove('d-none');
              btn.disabled = false;
              btn.innerText = 'เข้าสู่ระบบ';
            }
          })
          .withFailureHandler(err => {
            alertBox.innerText = "เกิดข้อผิดพลาด: " + err;
            alertBox.classList.remove('d-none');
            btn.disabled = false;
            btn.innerText = 'เข้าสู่ระบบ';
          })
          .loginUser(email, password);
      }

      function showAppView() {
        // ซ่อน Login แสดง App
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';

        // แสดงชื่อและ Role
        document.getElementById('userNameDisplay').innerText = currentUser.name;
        document.getElementById('userRoleDisplay').innerText = currentUser.role;
        document.getElementById('welcomeRole').innerText = currentUser.role;
      }

      function handleLogout() {
        if(confirm('ต้องการออกจากระบบใช่หรือไม่?')) {
          google.script.run.logoutUser(currentUser.email);
          currentUser = null;
          document.getElementById('app-view').style.display = 'none';
          document.getElementById('login-view').style.display = 'flex';
          
          // Reset ปุ่ม Login
          const btn = document.getElementById('btnLogin');
          btn.disabled = false;
          btn.innerText = 'เข้าสู่ระบบ';
          document.getElementById('password').value = '';
        }
      }
    </script>
  </body>
</html>
